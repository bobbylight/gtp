{"version":3,"sources":["gtp/AudioSystem.ts"],"names":["gtp","gtp.AudioSystem","gtp.AudioSystem.constructor","gtp.AudioSystem.init","gtp.AudioSystem.addSound","gtp.AudioSystem.fadeOutMusic","gtp.AudioSystem.getCurrentMusic","gtp.AudioSystem.isInitialized","gtp.AudioSystem.playMusic","gtp.AudioSystem.playSound","gtp.AudioSystem.stopMusic","gtp.AudioSystem.toggleMuted","gtp.AudioSystem.fadeMusic","gtp.AudioSystem.musicFadeSeconds"],"mappings":"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","file":"gtp/AudioSystem.js","sourcesContent":["module gtp {\r\n\t'use strict';\r\n\texport class AudioSystem {\r\n\r\n\t\tprivate _currentMusic: AudioBufferSourceNode;\r\n\t\tprivate _sounds: { [id: string]: gtp.Sound };\r\n\t\tprivate _musicFade: number;\r\n\t\tprivate _fadeMusic: boolean;\r\n\t\tprivate _muted: boolean;\r\n\t\tprivate _initialized: boolean;\r\n\r\n\t\tcontext: AudioContext;\r\n\t\tprivate _volumeFaderGain: GainNode;\r\n\t\tprivate _musicFaderGain: GainNode;\r\n\t\tprivate currentMusicId: string;\r\n\t\tprivate _musicLoopStart: number;\r\n\r\n\t\t/**\r\n\t\t * A wrapper around web audio for games.\r\n\t\t * \r\n\t\t * @constructor\r\n\t\t */\r\n\t\tconstructor() {\r\n\t\t\tthis._currentMusic = null;\r\n\t\t\tthis._sounds = {};\r\n\t\t\tthis._musicFade = 0.3; // seconds\r\n\t\t\tthis._fadeMusic = true;\r\n\t\t\tthis._muted = false;\r\n\t\t}\r\n\r\n\t\t/**\r\n\t\t * Initializes the audio system.\r\n\t\t */\r\n\t\tinit() {\r\n\t\t\ttry {\r\n\t\t\t\twindow.AudioContext = window.AudioContext || window.webkitAudioContext;\r\n\t\t\t\tthis.context = new window.AudioContext();\r\n\t\t\t\tthis._volumeFaderGain = this.context.createGain();\r\n\t\t\t\tthis._volumeFaderGain.gain.setValueAtTime(1, this.context.currentTime);\r\n\t\t\t\tthis._volumeFaderGain.gain.value = 1;\r\n\t\t\t\tthis._volumeFaderGain.connect(this.context.destination);\r\n\t\t\t\tthis._initialized = true;\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.error('The Web Audio API is not supported in this browser.');\r\n\t\t\t\tthis._initialized = false;\r\n\t\t\t}\r\n\t\t}\r\n   \r\n\t\t/**\r\n\t\t * Registers a sound for later playback.\r\n\t\t * @param sound {gtp.Sound} The sound.\r\n\t\t */\r\n\t\taddSound(sound: gtp.Sound) {\r\n\t\t\tif (this.context) {\r\n\t\t\t\tthis._sounds[sound.getId()] = sound;\r\n\t\t\t}\r\n\t\t}\r\n   \r\n\t\tfadeOutMusic(newMusicId: string) {\r\n\r\n\t\t\tif (this.context) {\r\n\t\t\t\tif (this._currentMusic) {\r\n\t\t\t\t\tif (!this._muted) {\r\n\t\t\t\t\t\t// We must \"anchor\" via setValueAtTime() before calling a *rampToValue() method (???)\r\n\t\t\t\t\t\tthis._musicFaderGain.gain.setValueAtTime(this._musicFaderGain.gain.value, this.context.currentTime);\r\n\t\t\t\t\t\tthis._musicFaderGain.gain.linearRampToValueAtTime(0, this.context.currentTime + this._musicFade);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar that: AudioSystem = this;\r\n\t\t\t\t\tsetTimeout(function() {\r\n\t\t\t\t\t\tthat.playMusic(newMusicId);\r\n\t\t\t\t\t}, this._musicFade * 1000);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tthis.playMusic(newMusicId);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n   \r\n\t\t/**\r\n\t\t * Returns the ID of the current music being played.\r\n\t\t * \r\n\t\t * @return {string} The current music's ID.\r\n\t\t */\r\n\t\tgetCurrentMusic(): string {\r\n\t\t\treturn this.currentMusicId;\r\n\t\t}\r\n   \r\n\t\t/**\r\n\t\t * Returns whether the audio system initialized properly.  This will return\r\n\t\t * false if the user's browser does not support the web audio API.\r\n\t\t * @return {boolean} Whether the sound system is initialized\r\n\t\t */\r\n\t\tisInitialized(): boolean {\r\n\t\t\treturn this._initialized;\r\n\t\t}\r\n   \r\n\t\t/**\r\n\t\t * Plays a specific sound as background music.  Only one \"music\" can play\r\n\t\t * at a time, as opposed to \"sounds,\" of which multiple can be playing at\r\n\t\t * one time.\r\n\t\t * @param {string} id The ID of the resource to play as music.  If this is\r\n\t\t *        <code>null</code>, the current music is stopped but no new music\r\n\t\t *        is started.\r\n\t\t * @param {boolean} loop Whether the music should loop.\r\n\t\t * @see stopMusic\r\n\t\t */\r\n\t\tplayMusic(id: string, loop?: boolean) {\r\n\r\n\t\t\tif (this.context) {\r\n         \r\n\t\t\t\t// Note: We destroy and recreate _musicFaderGain each time, because\r\n\t\t\t\t// it appears to occasionally start playing muted if we do not do\r\n\t\t\t\t// so, even when gain.value===1, on Chrome 38.\r\n\t\t\t\tif (this._currentMusic) {\r\n\t\t\t\t\tthis.stopMusic(false);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!id) {\r\n\t\t\t\t\treturn; // null id => don't play any music\r\n\t\t\t\t}\r\n\t\t\t\tvar sound: Sound = this._sounds[id];\r\n\t\t\t\tif (typeof loop === 'undefined') {\r\n\t\t\t\t\tloop = sound.getLoopsByDefaultIfMusic();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis._musicFaderGain = this.context.createGain();\r\n\t\t\t\tthis._musicFaderGain.gain.setValueAtTime(1, this.context.currentTime);\r\n\t\t\t\tthis._musicFaderGain.gain.value = 1;\r\n\t\t\t\tthis._currentMusic = this.context.createBufferSource();\r\n\t\t\t\tthis._currentMusic.loop = loop;\r\n\t\t\t\tthis._musicLoopStart = sound.getLoopStart() || 0;\r\n\t\t\t\tthis._currentMusic.loopStart = this._musicLoopStart;\r\n\t\t\t\tthis._currentMusic.buffer = sound.getBuffer();\r\n\t\t\t\tthis._currentMusic.loopEnd = this._currentMusic.buffer.duration;\r\n\t\t\t\tthis._currentMusic.connect(this._musicFaderGain);\r\n\t\t\t\tthis._musicFaderGain.connect(this._volumeFaderGain);\r\n\t\t\t\tthis._currentMusic.start(0);\r\n\t\t\t\tthis.currentMusicId = id;\r\n\t\t\t\tconsole.log('Just started new music with id: ' + id + ', loop: ' + loop);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n   \r\n\t\t/**\r\n\t\t * Plays the sound with the given ID.\r\n\t\t * @param {string} id The ID of the resource to play.\r\n\t\t */\r\n\t\tplaySound(id: string) {\r\n\t\t\tif (this.context) {\r\n\t\t\t\tvar source: AudioBufferSourceNode = this.context.createBufferSource();\r\n\t\t\t\tsource.buffer = this._sounds[id].getBuffer();\r\n\t\t\t\tsource.connect(this._volumeFaderGain);\r\n\t\t\t\tsource.start(0);\r\n\t\t\t}\r\n\t\t}\r\n   \r\n\t\t/**\r\n\t\t * Stops the currently playing music, if any.\r\n\t\t * @param {boolean} pause If <code>true</code>, the music is only paused;\r\n\t\t *        otherwise, native resources are freed and the music cannot be\r\n\t\t *        resumed.\r\n\t\t * @see playMusic\r\n\t\t */\r\n\t\tstopMusic(pause: boolean = false) {\r\n\t\t\tthis._currentMusic.stop();\r\n\t\t\tif (!pause) {\r\n\t\t\t\tthis._currentMusic.disconnect();\r\n\t\t\t\tthis._musicFaderGain.disconnect();\r\n\t\t\t\tdelete this._currentMusic;\r\n\t\t\t\tdelete this._musicFaderGain;\r\n\t\t\t}\r\n\t\t}\r\n   \r\n\t\ttoggleMuted(): boolean {\r\n\t\t\tthis._muted = !this._muted;\r\n\t\t\tif (this.context) {\r\n\t\t\t\tvar initialValue: number = this._muted ? 0 : 1;\r\n\t\t\t\tthis._volumeFaderGain.gain.setValueAtTime(initialValue, this.context.currentTime);\r\n\t\t\t\tthis._volumeFaderGain.gain.value = initialValue;\r\n\t\t\t}\r\n\t\t\treturn this._muted;\r\n\t\t}\r\n   \r\n\t\tget fadeMusic(): boolean {\r\n\t\t\t'use strict';\r\n\t\t\treturn this._fadeMusic;\r\n\t\t}\r\n   \r\n\t\tset fadeMusic(fade: boolean) {\r\n\t\t\tthis._fadeMusic = fade;\r\n\t\t}\r\n   \r\n\t\tget musicFadeSeconds(): number {\r\n\t\t\treturn this._musicFade;\r\n\t\t}\r\n   \r\n\t\tset musicFadeSeconds(seconds: number) {\r\n\t\t\tthis._musicFade = seconds;\r\n\t\t}\r\n\t}\r\n}"],"sourceRoot":"/source/"}