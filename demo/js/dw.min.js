/*! dw-html5 20141015 */
function init(a){"use strict";game=new DwGame({parent:a,scale:SCALE,width:CANVAS_WIDTH,height:CANVAS_HEIGHT}),game.setState(new LoadingState),game.start()}function _BaseState(){}function BattleEntity(a){"use strict";a=a||{},this.hp=a.maxHp||0,this.maxHp=a.maxHp||0,this.mp=a.maxMp||0,this.maxMp=a.maxMp||0}function RoamingEntity(){"use strict";this.direction=this.direction||Direction.SOUTH,this.mapCol=this.mapCol||0,this.mapRow=this.mapRow||0,this.xOffs=this.xOffs||0,this.yOffs=this.yOffs||0,this._stepTick=0}function Bubble(a,b,c,d,e){"use strict";this.title=a;var f=1;this.x=b*f,this.y=c*f,this.w=d*f,this.h=e*f,this._fontWidth=game.assets.get("font").cellW}function CommandBubble(){"use strict";var a=game._scale;Bubble.call(this,"COMMAND",90*a,2*a,140*a,90*a),this.selection=0}function TextBubble(a){"use strict";var b=a._scale,c=Bubble.MARGIN*b,d=a.getWidth()-2*c,e=TextBubble.HEIGHT*b;Bubble.call(this,null,c,a.getHeight()-c-e,d,e)}function QuestionBubble(a,b){"use strict";var c=a._scale,d=Bubble.MARGIN*c,e=200*c,f=20*c,g=a.getWidth()-2*d,h=TextBubble.HEIGHT*c;Bubble.call(this,null,e,f,g,h),this._choices=b,this._curChoice=0}function Hero(a){"use strict";RoamingEntity.call(this,a),this.name=a.name,this.level=1,this.gold=0,this.exp=0,this.strength=5}function MapLogic(){}function Npc(a){"use strict";RoamingEntity.call(this,a),gtp.Utils.mixin(a,this),this._origMapRow=this.mapRow,this._origMapCol=this.mapCol,this._origDir=this.direction,this._stepDelay=new gtp.Delay(3e3,-500,500)}function Conversation(){"use strict";this._segments=[],this._responses=[]}function Brecconary(){}function Overworld(){}var SCALE=2,tileSize=16*SCALE,CANVAS_WIDTH=17*tileSize,CANVAS_HEIGHT=15*tileSize,game,gtp=gtp||{};gtp.Utils=function(){},gtp.Utils.getObjectSize=function(a){"use strict";var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},gtp.Utils.mixin=function(a,b){"use strict";for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c])},gtp.Utils.randomInt=function(a,b){"use strict";return Math.floor(Math.random()*(b-a))+a},gtp.Utils.initConsole=function(){"use strict";if(!window.console){var a=function(){};window.console={log:a,warn:a,error:a}}};var gtp=gtp||{};gtp.ImageUtils=function(){},gtp.ImageUtils.resize=function(a,b){"use strict";var c,d;if("img"===a.nodeName.toLowerCase()?(c=gtp.ImageUtils.createCanvas(a.width,a.height),d=c.getContext("2d"),d.drawImage(a,0,0)):(c=a,d=c.getContext("2d")),1===b)return c;for(var e=d.getImageData(0,0,a.width,a.height),f=a.width*b,g=a.height*b,h=gtp.ImageUtils.createCanvas(f,g),i=h.getContext("2d"),j=i.getImageData(0,0,f,g),k=0;g>k;k++)for(var l=0;f>l;l++){var m=4*(Math.floor(k/b)*a.width+Math.floor(l/b)),n=4*(k*f+l);j.data[n]=e.data[m],j.data[n+1]=e.data[m+1],j.data[n+2]=e.data[m+2],j.data[n+3]=e.data[m+3]}return i.putImageData(j,0,0),h},gtp.ImageUtils.createCanvas=function(a,b,c){"use strict";var d=document.createElement("canvas");return d.width=a,d.height=b,gtp.ImageUtils.prepCanvas(d),c&&("string"==typeof c&&(c=document.getElementById(c)),c.appendChild(d)),d},gtp.ImageUtils.prepCanvas=function(a){"use strict";var b=a.getContext("2d");b.imageSmoothingEnabled=!1,b.mozImageSmoothingEnabled=!1,b.oImageSmoothingEnabled=!1,b.webkitImageSmoothingEnabled=!1,b.msImageSmoothingEnabled=!1},gtp.ImageUtils.makeColorTranslucent=function(a,b,c){"use strict";b=b||0,c=c||0;for(var d=a.getContext("2d"),e=a.width,f=a.height,g=d.getImageData(0,0,e,f),h=[],i=4*(c*e+b),j=0;4>j;j++)h[j]=g.data[i+j];for(c=0;f>c;c++)for(b=0;e>b;b++){var k=4*(c*e+b);g.data[k]===h[0]&&g.data[k+1]===h[1]&&g.data[k+2]===h[2]&&g.data[k+3]===h[3]&&(g.data[k]=0,g.data[k+1]=0,g.data[k+2]=0,g.data[k+3]=0)}return d.putImageData(g,0,0),a};var gtp=gtp||{};gtp.Timer=function(){"use strict";this._startTimes=[],this._prefix="DEBUG"},gtp.Timer.prototype={setLogPrefix:function(a){"use strict";this._prefix=a||"DEBUG"},start:function(a){"use strict";this._startTimes[a]=(new Date).getTime()},end:function(a){"use strict";var b=this._startTimes[a];if(!b)return console.error('Cannot end timer for "'+a+'" as it was never started'),-1;var c=(new Date).getTime()-b;return delete this._startTimes[a],c},endAndLog:function(a){"use strict";var b=this.end(a);b>-1&&console.log(this._prefix+": "+a+": "+b+" ms")}};var gtp=gtp||{};gtp.Delay=function(a,b,c){"use strict";this._initial=a.length?a:[a],this._initialIndex=0,b&&c&&this.setRandomDelta(b,c),this.reset()},gtp.Delay.prototype={update:function(a){"use strict";return this._remaining>0&&(this._remaining-=a),this.isDone()},isDone:function(){"use strict";return this._remaining<=0},setRandomDelta:function(a,b){"use strict";this._minDelta=a,this._maxDelta=b},reset:function(){"use strict";this._remaining=this._initial[this._initialIndex],this._initialIndex=(this._initialIndex+1)%this._initial.length,(this._minDelta||this._maxDelta)&&(this._remaining+=gtp.Utils.randomInt(this._minDelta,this._maxDelta))}};var gtp=gtp||{};gtp.Image=function(a){"use strict";this._canvas=a,this.width=this._canvas.width,this.height=this._canvas.height,this._ensure256Square()},gtp.Image.prototype={_ensure256Square:function(){"use strict";if(this._canvas.width<256||this._canvas.height<256){var a=Math.max(256,this._canvas.width),b=Math.max(256,this._canvas.height),c=gtp.ImageUtils.createCanvas(a,b),d=c.getContext("2d");d.drawImage(this._canvas,0,0),this._canvas=c}},draw:function(a,b,c){"use strict";a.drawImage(this._canvas,b,c)},drawScaled:function(a,b,c,d,e){"use strict";a.drawImage(this._canvas,b,c,d,e)},drawScaled2:function(a,b,c,d,e,f,g,h,i){"use strict";a.drawImage(this._canvas,b,c,d,e,f,g,h,i)},makeColorTranslucent:function(a,b){"use strict";gtp.ImageUtils.makeColorTranslucent(this._canvas,a,b)}};var gtp=gtp||{};gtp.AudioSystem=function(){"use strict";this._currentMusic=null,this._soundBuffers={},this._musicFade=.3,this._fadeMusic=!0},gtp.AudioSystem.prototype={init:function(){"use strict";try{window.AudioContext=window.AudioContext||window.webkitAudioContext,this.context=new window.AudioContext,this._initialized=!0}catch(a){console.error("The Web Audio API is not supported in this browser."),this._initialized=!1}},addSound:function(a,b){"use strict";this.context&&(this._soundBuffers[a]=b)},isInitialized:function(){"use strict";return this._initialized},fadeOutMusic:function(a){"use strict";if(this.context)if(this._currentMusic){this._faderGain.gain.setValueAtTime(this._faderGain.gain.value,this.context.currentTime),this._faderGain.gain.linearRampToValueAtTime(0,this.context.currentTime+this._musicFade);var b=this;setTimeout(function(){b.playMusic(a)},1e3*this._musicFade)}else this.playMusic(a)},playMusic:function(a){"use strict";this.context&&(this._currentMusic&&(this._currentMusic.stop(),this._currentMusic.disconnect(),delete this._currentMusic,this._faderGain.disconnect(),delete this._faderGain),this._faderGain=this.context.createGain(),this._faderGain.gain.setValueAtTime(1,this.context.currentTime),this._faderGain.gain.value=1,this._currentMusic=this.context.createBufferSource(),this._currentMusic.buffer=this._soundBuffers[a],this._currentMusic.loop=!0,this._currentMusic.connect(this._faderGain),this._faderGain.connect(this.context.destination),this._currentMusic.start(0),console.log("Just started new music with id: "+a))},playSound:function(a){"use strict";if(this.context){var b=this.context.createBufferSource();b.buffer=this._soundBuffers[a],b.connect(this.context.destination),b.start(0)}},get fadeMusic(){"use strict";return this._fadeMusic},set fadeMusic(a){"use strict";this._fadeMusic=a||!1},get musicFadeSeconds(){"use strict";return this._musicFade},set musicFadeSeconds(a){"use strict";this._musicFade=a}};var gtp=gtp||{};gtp.AssetType=Object.freeze({UNKNOWN:0,IMAGE:1,AUDIO:2,JSON:3});var gtp=gtp||{};gtp.AssetLoader=function(a,b){"use strict";this._scale=a||1,this.loadingAssetData={},this.responses={},this.callback=null,this.audio=b},gtp.AssetLoader.prototype={addJson:function(a,b){"use strict";if(b=b||a,!this._isAlreadyTracked(a)){this.loadingAssetData[a]={type:gtp.AssetType.JSON},console.log("Adding: "+a+" => "+b+", remaining == "+gtp.Utils.getObjectSize(this.loadingAssetData)+", callback == "+(null!==this.callback));var c=this,d=new XMLHttpRequest;d.onreadystatechange=function(){if(4===d.readyState){var b=d.responseText;c._completed(a,b)}},d.open("GET",b,!0),d.send(null)}},addImage:function(a,b){"use strict";var c=this,d=new Image;this._isAlreadyTracked(a)||(this.loadingAssetData[a]={type:gtp.AssetType.IMAGE},console.log("Adding: "+a+" => "+b+", remaining == "+gtp.Utils.getObjectSize(this.loadingAssetData)+", callback == "+(null!==this.callback)),d.addEventListener("load",function(){var b=gtp.ImageUtils.resize(d,c._scale),e=new gtp.Image(b);c._completed(a,e)}),d.src=b)},addSound:function(a,b){"use strict";if(this.audio.isInitialized()){if(this._isAlreadyTracked(a))return;this.loadingAssetData[a]={type:gtp.AssetType.SOUND};var c=this,d=new XMLHttpRequest;d.onload=function(){c.audio.context.decodeAudioData(d.response,function(b){c.audio.addSound(a,b),c._completed(a,b)})},d.open("GET",b,!0),d.responseType="arraybuffer",d.send(null)}},addSpriteSheet:function(a,b,c,d,e,f){"use strict";var g=this;e=e||0,c*=g._scale,d*=g._scale,e*=g._scale;var h=new Image;this._isAlreadyTracked(a)||(this.loadingAssetData[a]={type:gtp.AssetType.IMAGE},console.log("Adding: "+a+" => "+b+", remaining == "+gtp.Utils.getObjectSize(this.loadingAssetData)+", callback == "+(null!==this.callback)),h.addEventListener("load",function(){var b=gtp.ImageUtils.resize(h,g._scale),i=new gtp.Image(b);f&&i.makeColorTranslucent(0,0);var j=new gtp.SpriteSheet(i,c,d,e);g._completed(a,j)}),h.src=b)},addTmxMap:function(a){"use strict";if(a.tilesets&&a.tilesets.length)for(var b=0;b<a.tilesets.length;b++){var c=a.tilesets[b],d="_tilesetImage_"+c.name;this.addImage(d,c.image)}},getTmxTilesetImage:function(a){"use strict";return this.responses["_tilesetImage_"+a.name]},get:function(a){"use strict";return this.responses[a]},_isAlreadyTracked:function(a){"use strict";return this.loadingAssetData[a]?(console.log("A resource with id "+a+" is already loading.  Assuming they are the same"),!0):this.responses[a]?(console.log("A resource with id "+a+" has already been loaded."),!0):void 0},set:function(a,b){"use strict";this.responses[a]=b},_completed:function(a,b){"use strict";return this.loadingAssetData[a]?(this.loadingAssetData[a].type===gtp.AssetType.JSON&&(b=JSON.parse(b)),this.responses[a]=b,delete this.loadingAssetData[a],console.log("Completed: "+a+", remaining == "+gtp.Utils.getObjectSize(this.loadingAssetData)+", callback == "+(null!==this.callback)),void(this.isDoneLoading()&&this.callback?(this.callback.call(),delete this.callback,console.log("... Callback called and deleted (callback == "+(null!==this.callback)+")"),this.nextCallback&&(this.callback=this.nextCallback,delete this.nextCallback)):console.log("... Not running callback - "+this.isDoneLoading()+", "+(null!==this.callback)))):void console.error("Resource not found! - "+a)},isDoneLoading:function(){"use strict";return 0===gtp.Utils.getObjectSize(this.loadingAssetData)},onLoad:function(a){"use strict";this.isDoneLoading()?a.call():this.callback?this.nextCallback=a:this.callback=a}};var gtp=gtp||{};gtp.SpriteSheet=function(a,b,c,d){"use strict";this.gtpImage=a,this.cellW=b,this.cellH=c,this.spacing=d||1,this.rowCount=Math.floor(a.height/(c+d)),a.height-this.rowCount*(c+d)>=c&&this.rowCount++,this.colCount=Math.floor(a.width/(b+d)),a.width-this.colCount*(b+d)>=b&&this.colCount++,this.size=this.rowCount*this.colCount},gtp.SpriteSheet.prototype={drawSprite:function(a,b,c,d,e){"use strict";var f=this.cellW,g=this.cellH,h=(f+this.spacing)*e,i=(g+this.spacing)*d;this.gtpImage.drawScaled2(a,h,i,f,g,b,c,f,g)},drawByIndex:function(a,b,c,d){"use strict";var e=Math.floor(d/this.colCount),f=Math.floor(d%this.colCount);this.drawSprite(a,b,c,e,f)}};var gtp=gtp||{};gtp.BitmapFont=function(){"use strict";gtp.SpriteSheet.apply(this,arguments)},gtp.BitmapFont.prototype=Object.create(gtp.SpriteSheet.prototype,{drawString:{value:function(a,b,c){"use strict";for(var d=this.size,e=game.canvas.getContext("2d"),f=this.cellW,g=0;g<a.length;g++){var h=a.charCodeAt(g)-32;(0>h||h>=d)&&(h=0),this.drawByIndex(e,b,c,h),b+=f}}}}),gtp.BitmapFont.prototype.constructor=gtp.BitmapFont;var gtp=gtp||{};gtp.InputManager=function(){"use strict";this.keys=[]},gtp.InputManager.prototype={clearKeyStates:function(){"use strict";for(var a=0;a<this.keys.length;a++)this.keys[a]=!1},install:function(){"use strict";var a=this;document.onkeydown=function(b){a._keyDown(b)},document.onkeyup=function(b){a._keyUp(b)}},_keyDown:function(a){"use strict";var b=a.keyCode;(32===b||b>=37&&40>=b)&&a.preventDefault(),this.keys[a.keyCode]=!0,a.stopPropagation()},_keyUp:function(a){"use strict";this.keys[a.keyCode]=!1,a.stopPropagation()},isKeyDown:function(a,b){"use strict";var c=this.keys[a];return b&&(this.keys[a]=!1),c}};var gtp=gtp||{};gtp.Keys=Object.freeze({ENTER:13,SHIFT:16,SPACE:32,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90});var gtp=gtp||{};gtp.Game=function(a){"use strict";gtp.Utils.initConsole(),a=a||{},this._scale=a.scale||1,this.canvas=gtp.ImageUtils.createCanvas(a.width,a.height,a.parent),this.inputManager=new gtp.InputManager,this.inputManager.install(),this._gameTime=0,this._targetFps=arguments.targetFps||30,this._interval=1e3/this._targetFps,this.lastTime=null,this.audio=new gtp.AudioSystem,this.audio.init(),this.assets=new gtp.AssetLoader(this._scale,this.audio),this.clearScreenColor="rgb(0,0,0)",this.fpsColor="rgb(255,255,255)",this.statusMessageRGB="255,255,255",this._statusMessageColor=null,this.showFps=!0,this.frames=0,this._fpsMsg=this._targetFps+" fps",this._statusMessage=null,this._statusMessageAlpha=0,this.timer=new gtp.Timer},gtp.Game.prototype={start:function(){"use strict";var a=this,b=function(){a._gameTime+=a._interval,a._tick.apply(a)};setInterval(b,this._interval)},_tick:function(){"use strict";if(this._statusMessage){var a=(new Date).getTime();if(a>this._statusMessageTime){this._statusMessageTime=a+100,this._statusMessageAlpha-=.1;var b=Math.min(1,this._statusMessageAlpha);this._statusMessageColor="rgba("+this.statusMessageRGB+","+b+")",this._statusMessageAlpha<=0&&(this._statusMessage=null)}}this.update(),this.render()},update:function(){"use strict";var a=this.inputManager;a.isKeyDown(gtp.Keys.SHIFT)&&a.isKeyDown(gtp.Keys.F,!0)&&game.toggleShowFps(),this.state.update(this._interval)},render:function(){"use strict";var a=this.canvas.getContext("2d");this.state.render(a),this.showFps&&this._renderFps(a),this._statusMessage&&this._statusMessageAlpha>0&&this._renderStatusMessage(a)},getHeight:function(){"use strict";return this.canvas.height},getWidth:function(){"use strict";return this.canvas.width},randomInt:function(a){"use strict";var b=0;return Math.floor(Math.random()*(a-b+1)+b)},setState:function(a){"use strict";this.state&&this.state.leaving(this),this.state=a,this.state.init(this)},_renderStatusMessage:function(a){"use strict";var b=10,c=this.canvas.height-30;a.font="Dragon Warrior 2",a.fillStyle=this._statusMessageColor,a.fillText(this._statusMessage,b,c)},_renderFps:function(a){"use strict";this.frames++;var b=(new Date).getTime();null===this.lastTime?this.lastTime=b:b-this.lastTime>=1e3&&(this._fpsMsg=this.frames+" fps",this.frames=0,this.lastTime=b);var c=10,d=15;a.font="10pt Arial",a.fillStyle=this.fpsColor,a.fillText(this._fpsMsg,c,d)},setStatusMessage:function(a){"use strict";this._statusMessage=a,this._statusMessageAlpha=2,this._statusMessageTime=(new Date).getTime()+100},toggleShowFps:function(){"use strict";this.showFps=!this.showFps,this.setStatusMessage("FPS display: "+(this.showFps?"on":"off"))},clearScreen:function(a){"use strict";var b=a||this.clearScreenColor,c=this.canvas.getContext("2d");c.fillStyle=b,c.fillRect(0,0,this.getWidth(),this.getHeight())}};var gtp=gtp||{};gtp.State=function(){},gtp.State.prototype={init:function(a){"use strict";this.game=a},leaving:function(){},update:function(){},render:function(){}};var gtp=gtp||{};gtp.FadeOutInState=function(a,b,c,d){"use strict";this._leavingState=a,this._enteringState=b,this._transitionLogic=c,this._fadingOut=!0,this._alpha=1,this._halfTime=d&&d>0?d/2:800,this._curTime=0},gtp.FadeOutInState.prototype=Object.create(gtp.State.prototype,{update:{value:function(a){"use strict";if(this._curTime+=a,this._curTime>=this._halfTime){if(this._curTime-=this._halfTime,!this._fadingOut)return void this._setState(this._enteringState);this._fadingOut=!1,this._transitionLogic&&this._transitionLogic()}var b;this._fadingOut?(this._alpha=1-this._curTime/this._halfTime,b=this._leavingState):(this._alpha=this._curTime/this._halfTime,b=this._enteringState)}},render:{value:function(a){"use strict";var b=this.game;b.clearScreen();var c=a.globalAlpha;a.globalAlpha=this._alpha,this._fadingOut?this._leavingState.render(a):this._enteringState.render(a),a.globalAlpha=c}},_setState:{value:function(){"use strict";game.setState(this._enteringState)}}}),gtp.FadeOutInState.prototype.constructor=gtp.FadeOutInState;var tiled=tiled||{};tiled.TiledTileset=function(a,b){"use strict";this.firstgid=a.firstgid,this.image=a.image,b&&(this.image=b(this.image)),this.imageWidth=a.imagewidth,this.imageHeight=a.imageheight,this.margin=a.margin,this.name=a.name,this.properties=a.properties,this.spacing=a.spacing,this.tileWidth=a.tilewidth,this.tileHeight=a.tileheight},tiled.TiledTileset.prototype={setScale:function(a){"use strict";this.imageWidth*=a,this.imageHeight*=a,this.tileWidth*=a,this.tileHeight*=a,this.margin*=a,this.spacing*=a}};var tiled=tiled||{};tiled.TiledMap=function(a,b){"use strict";this.rowCount=a.height,this.colCount=a.width,this.tileWidth=b.tileWidth,this.tileHeight=b.tileHeight,this.screenWidth=b.screenWidth,this.screenHeight=b.screenHeight,this.screenRows=Math.ceil(this.screenHeight/this.tileHeight),this.screenCols=Math.ceil(this.screenWidth/this.tileWidth);var c=b?b.imagePathModifier:null;this.layers=[],this.layersByName={},this.objectGroups=[];for(var d=0;d<a.layers.length;d++)this.addLayer(a.layers[d]);if(this.tilesets=[],a.tilesets&&a.tilesets.length)for(d=0;d<a.tilesets.length;d++)this.tilesets.push(new tiled.TiledTileset(a.tilesets[d],c));this.properties=a.properties,this.version=a.version,this.orientation=a.orientation},tiled.TiledMap.prototype={addLayer:function(a){"use strict";var b=new tiled.TiledLayer(this,a);this.layers.push(b),this.layersByName[b.name]=b,"objectgroup"===a.type&&(b.objectGroup=!0,this.objectGroups.push(b))},draw:function(a,b,c,d,e){"use strict";d=d||0,e=e||0;var f=this.colCount,g=this.rowCount,h=this.screenRows,i=this.screenCols,j=this.tileWidth,k=this.tileHeight,l=j,m=this.screenWidth,n=this.screenHeight,o=c-Math.floor(h/2);0>o&&(o+=f);var p=b-Math.floor(i/2);0>p&&(p+=g);var q=c*j+d+j/2,r=b*k+e+k/2,s=q-m/2,t=r-n/2,u=Math.floor(s/j);0>s%l&&u--;var v=u*j,w=Math.floor(t/k);0>t%l&&w--;var x=w*k,y=v-s,z=y,A=x-t,B=A;0>u&&(u+=f),0>w&&(w+=g);for(var C=w,D=this.getLayerCount(),E=0;n>B;){for(var F=0;D>F;F++){var G=u;z=y;var H=this.getLayerByIndex(F);if(H.visible){var I;for(H.opacity<1&&(I=a.globalAlpha,a.globalAlpha=I*H.opacity);m>z;){var J=H.getData(C%g,G%f);this.drawTile(a,z,B,J,H),E++,z+=j,G++}H.opacity<1&&(a.globalAlpha=I)}}B+=k,C++}},getLayer:function(a){"use strict";return this.layersByName[a]},getLayerByIndex:function(a){"use strict";return this.layers[a]},getLayerCount:function(){"use strict";return this.layers.length},_getImageForGid:function(a){"use strict";for(var b=this.tilesets.length,c=0;b>c;c++)if(this.tilesets[c].firstgid>a)return this.tilesets[c-1];return this.tilesets[b-1]},drawTile:function(a,b,c,d,e){"use strict";if(!(0>=d)){var f=this._getImageForGid(d);if(!f)return void console.log("null tileset for: "+d+" (layer "+e.name+")");if(d-=f.firstgid,!(0>d)){var g=game.assets.getTmxTilesetImage(f),h=this.tileWidth,i=h+f.spacing,j=this.tileHeight,k=j+f.spacing,l=Math.floor(g.width/i);f.spacing>0&&g.width%i===h&&l++;var m=Math.floor(d/l)*k,n=d%l*i;g.drawScaled2(a,n,m,h,j,b,c,h,j)}}},setScale:function(a){"use strict";this.tileWidth*=a,this.tileHeight*=a,this.screenRows=Math.ceil(this.screenHeight/this.tileHeight),this.screenCols=Math.ceil(this.screenWidth/this.tileWidth);for(var b=this.tilesets.length,c=0;b>c;c++)return this.tilesets[c].setScale(a)},getPixelWidth:function(){"use strict";return this.colCount*this.tileWidth},getPixelHeight:function(){"use strict";return this.rowCount*this.tileHeight},removeLayer:function(a){"use strict";for(var b=0;b<this.layers.length;b++){if(this.layers[b].name===a){this.layers.splice(b,1),delete this.layersByName[a];for(var c=0;c<this.objectGroups.length;c++)this.objectGroups[c].name===a&&delete this.objectGroups[c]}return!0}return!1}};var tiled=tiled||{};tiled.TiledObject=function(a){"use strict";gtp.Utils.mixin(a,this),this.properties=this.properties||{},this.gid=this.gid||-1,this.x*=game._scale,this.y*=game._scale,this.width*=game._scale,this.height*=game._scale},tiled.TiledObject.prototype={intersects:function(a,b,c,d){"use strict";var e=this.width,f=this.height,g=c,h=d;if(0>=g||0>=h||0>=e||0>=f)return!1;var i=this.x,j=this.y,k=a,l=b;return g+=k,h+=l,e+=i,f+=j,(k>g||g>i)&&(l>h||h>j)&&(i>e||e>k)&&(j>f||f>l)}};var tiled=tiled||{};tiled.TiledLayer=function(a,b){"use strict";this.map=a,this.name=b.name,this.width=b.width,this.height=b.height,this.data=b.data,this.opacity=b.opacity,this.visible=b.visible,this.type=b.type,this.x=b.x,this.y=b.y,this._setObjects(b.objects)},tiled.TiledLayer.prototype={getData:function(a,b){"use strict";if(!this.data)return-1;var c=a*this.map.colCount+b;return this.data[c]},setData:function(a,b,c){"use strict";if(!this.data)return!1;var d=a*this.map.colCount+b;this.data[d]=c},getObjectByName:function(a){"use strict";return this.objectsByName?this.objectsByName[a]:null},getObjectIntersecting:function(a,b,c,d){"use strict";if(this.objects)for(var e=0;e<this.objects.length;e++){var f=this.objects[e];if(f.intersects(a,b,c,d))return f}return null},isObjectGroup:function(){"use strict";return"objectgroup"===this.type},_setObjects:function(a){"use strict";if(a){this.objects=[],this.objectsByName={};for(var b=0;b<a.length;b++){var c=new tiled.TiledObject(a[b]);this.objects.push(c),this.objectsByName[a[b].name]=c}}}};var DwGame=function(a){"use strict";gtp.Game.call(this,a),this.map=null,this._drawMapCount=0,this.hero=new Hero({name:"Erdrick"}),this.npcs=[],this._bumpSoundDelay=0,this._mapLogics={}};DwGame.prototype=Object.create(gtp.Game.prototype,{update:{value:function(){"use strict";gtp.Game.prototype.update.call(this)}},drawMap:{value:function(a){"use strict";var b=game.hero,c=b.mapCol,d=b.mapRow,e=b.xOffs,f=b.yOffs;this._drawMapCount++,this.map.draw(a,d,c,e,f)}},getMapLogic:{value:function(){"use strict";var a=this.map.properties.logicFile;a=a.charAt(0).toUpperCase()+a.substring(1),console.log(a);var b=this._mapLogics[a];return b||(b=this._mapLogics[a]=new window[a]),console.log("... "+b),b}},getMapXOffs:{value:function(){"use strict";var a=game.hero,b=a.mapCol,c=a.xOffs,d=this.getTileSize(),e=b*d+d/2+c-this.getWidth()/2;return e}},getMapYOffs:{value:function(){"use strict";var a=game.hero,b=a.mapRow,c=a.yOffs,d=this.getTileSize(),e=b*d+d/2+c-this.getHeight()/2;return e}},loadMap:{value:function(a,b,c){"use strict";this.newRow=b,this.newCol=c,this.audio.playSound("stairs");var d=this,e=function(){d.hero.setMapLocation(-1,-1),d.setMap(a+".json"),d.hero.setMapLocation(b,c),d.inputManager.clearKeyStates()};this.setState(new MapChangeState(this.state,this.state,e))}},getMapImpl:{value:function(a){"use strict";var b=null;return b=this.assets.get(a+".json")}},_resetMap:{value:function(a){"use strict";for(var b=0;b<a.npcs.length;b++)a.npcs[b].reset()}},setMap:{value:function(a){"use strict";console.log("Setting map to: "+a),this.map=this.maps[a],this._resetMap(this.maps[a]),this.audio.fadeOutMusic("overworldMusic")}},initLoadedMap:{value:function(a){"use strict";var b=this.assets.get(a),c=function(a){return a.replace("../maps","res")};this.maps||(this.maps={});var d=new tiled.TiledMap(b,{imagePathModifier:c,tileWidth:16,tileHeight:16,screenWidth:game.getWidth(),screenHeight:game.getHeight()});return this._adjustGameMap(d),d.setScale(this._scale),this.maps[a]=d,d}},_adjustGameMap:{value:function(a){"use strict";var b,c;for(b=0;b<a.getLayerCount();b++){var d=a.getLayerByIndex(b);"tileLayer"!==d.name&&(d.visible=!1)}var e=[],f={},g=a.getLayer("npcLayer");if(g&&g.isObjectGroup()){var h=g;for(b=0;b<h.objects.length;b++){var i=h.objects[b];"npc"===i.type?(c=this._parseNpc(i),c.setNpcIndex(e.length+1),e.push(c)):"talkAcross"===i.type?f[this._parseTalkAcrossKey(i)]=!0:console.error("Unhandled object type in tiled map: "+i.type)}a.removeLayer("npcs")}for(a.npcs=e,b=0;b<a.npcs.length;b++)c=a.npcs[b],a.getLayer("collisionLayer").setData(c.mapRow,c.mapCol,1);a.talkAcrosses=f}},_parseNpc:{value:function(a){"use strict";var b,c=a.name;a.properties.type&&(b=NpcType[a.properties.type.toUpperCase()]),b||(b=NpcType.MERCHANT_GREEN);var d=this.getTileSize(),e=a.y/d,f=a.x/d,g=Direction.SOUTH,h=a.properties.dir;h&&(g=Direction[h.toUpperCase()]||Direction.SOUTH);var i=!0,j=a.wanders;j&&(i="true"===j);var k=new Npc({name:c,type:b,direction:g,wanders:i,mapRow:e,mapCol:f});return k}},_parseTalkAcrossKey:{value:function(a){"use strict";var b=this.getTileSize(),c=a.y/b,d=a.x/b;return this._getTalkAcrossKey(c,d)}},_getTalkAcrossKey:{value:function(a,b){"use strict";return a+","+b}},toggleShowCollisionLayer:{value:function(){"use strict";var a=this.getCollisionLayer();a.visible=!a.visible,this.setStatusMessage(a.visible?"Collision layer showing":"Collision layer hidden")}},toggleShowTerritoryLayer:{value:function(){"use strict";var a=this.map.getLayer("enemyTerritoryLayer");a.visible=!a.visible,this.setStatusMessage(a.visible?"Territory layer showing":"Territory layer hidden")}},getTileSize:{value:function(){"use strict";return 16*this._scale}},getCollisionLayer:{value:function(){"use strict";return game.map.getLayer("collisionLayer")}},bump:{value:function(){"use strict";this._gameTime>this._bumpSoundDelay&&(this.audio.playSound("bump"),this._bumpSoundDelay=this._gameTime+300)}},setNpcsPaused:{value:function(a){"use strict";this.npcsPaused=a}},stringHeight:{value:function(){"use strict";return this.assets.get("font").cellH}},stringWidth:{value:function(a){"use strict";return a?a.length*this.assets.get("font").cellW:0}},drawString:{value:function(a,b,c){"use strict";this.assets.get("font").drawString(a,b,c)}},drawArrow:{value:function(a,b){"use strict";this.drawString("",a,b)}},startRandomEncounter:{value:function(){"use strict";console.log("Start a random encounter!")}},getNpcHeroIsFacing:{value:function(){"use strict";var a=this.hero.mapRow,b=this.hero.mapCol;do switch(this.hero.direction){case Direction.NORTH:a--;break;case Direction.SOUTH:a++;break;case Direction.EAST:b++;break;case Direction.WEST:b--}while(this.getShouldTalkAcross(a,b));for(var c=0;c<this.map.npcs.length;c++){var d=this.map.npcs[c];if(a===d.mapRow&&b===d.mapCol)return d}return null}},getShouldTalkAcross:{value:function(a,b){"use strict";return this.map.talkAcrosses[this._getTalkAcrossKey(a,b)]}},anyKeyPressed:{value:function(){"use strict";var a=this.inputManager;return a.isKeyDown(gtp.Keys.X,!0)||a.isKeyDown(gtp.Keys.Z,!0)}},actionKeyPressed:{value:function(){"use strict";return this.inputManager.isKeyDown(gtp.Keys.Z,!0)}},cancelKeyPressed:{value:function(){"use strict";return this.inputManager.isKeyDown(gtp.Keys.X,!0)}}}),DwGame.prototype.constructor=DwGame,_BaseState.prototype=Object.create(gtp.State.prototype,{handleDefaultKeys:{value:function(){"use strict";var a=this.game.inputManager;a.isKeyDown(gtp.Keys.SHIFT)&&(a.isKeyDown(gtp.Keys.P,!0)?(game.canvas.style.width||(game.canvas.style.width=game.canvas.width+"px"),game.canvas.style.height||(game.canvas.style.height=game.canvas.height+"px"),game.canvas.style.width=parseInt(game.canvas.style.width.substring(0,game.canvas.style.width.length-2),10)+1+"px",game.canvas.style.height=parseInt(game.canvas.style.height.substring(0,game.canvas.style.height.length-2),10)+1+"px"):a.isKeyDown(gtp.Keys.L,!0)&&(game.canvas.style.width||(game.canvas.style.width=game.canvas.width+"px"),game.canvas.style.height||(game.canvas.style.height=game.canvas.height+"px"),console.log("... "+game.canvas.width+", "+game.canvas.style.width+", "+game.canvas.style.width.substring(0,game.canvas.style.width-2)),game.canvas.style.width=parseInt(game.canvas.style.width.substring(0,game.canvas.style.width.length-2),10)-1+"px",game.canvas.style.height=parseInt(game.canvas.style.height.substring(0,game.canvas.style.height.length-2),10)-1+"px"))}}}),_BaseState.prototype.constructor=_BaseState,RoamingEntity.prototype={getMoveIncrement:function(){"use strict";return 2*game._scale},isMoving:function(){"use strict";return 0!==this.xOffs||0!==this.yOffs},handleIsMovingInUpdate:function(){"use strict";this.isMoving()&&(this.xOffs<0?this.xOffs+=this.getMoveIncrement():this.xOffs>0?this.xOffs-=this.getMoveIncrement():this.yOffs<0?this.yOffs+=this.getMoveIncrement():this.yOffs>0&&(this.yOffs-=this.getMoveIncrement()),this.isMoving()||this.handlePostMove())},handlePostMove:function(){},setMapLocation:function(a,b){"use strict";if(null!=this.mapRow&&null!=this.mapCol){var c=game.getCollisionLayer();console.log("*** clearing data at: "+this.mapRow+", "+this.mapCol),c.setData(this.mapRow,this.mapCol,0),a>-1&&b>-1&&c.setData(a,b,1)}this.mapRow=a,this.mapCol=b,this.xOffs=this.yOffs=0},_tryToMove:function(a,b){"use strict";var c=game.getCollisionLayer().getData(a,b),d=0===c;return d?this.setMapLocation(a,b):361===c&&"Hero"===this.constructor.name&&game.bump(),d},tryToMoveLeft:function(){"use strict";var a=!1,b=this.mapCol-1;return 0>b&&(b+=game.map.colCount),this._tryToMove(this.mapRow,b)&&(this.xOffs=game.getTileSize(),a=!0),this.direction=Direction.WEST,a},tryToMoveRight:function(){"use strict";var a=!1,b=Math.floor((this.mapCol+1)%game.map.colCount);return this._tryToMove(this.mapRow,b)&&(this.xOffs=-game.getTileSize(),a=!0),this.direction=Direction.EAST,a},tryToMoveUp:function(){"use strict";var a=!1,b=this.mapRow-1;return 0>b&&(b+=game.map.rowCount),this._tryToMove(b,this.mapCol)&&(this.yOffs+=game.getTileSize(),a=!0),this.direction=Direction.NORTH,a},tryToMoveDown:function(){"use strict";var a=!1,b=Math.floor((this.mapRow+1)%game.map.rowCount);return this._tryToMove(b,this.mapCol)&&(this.yOffs-=game.getTileSize(),a=!0),this.direction=Direction.SOUTH,a}},Bubble.MARGIN=10,Bubble.prototype={_breakApart:function(a,b){"use strict";for(var c=[],d=a.split("\n"),e=0;e<d.length;e++)this._breakApartLine(d[e],b,c);return c},_breakApartLine:function(a,b,c){"use strict";for(var d=Math.floor(b/this._fontWidth);a.length>d;){for(var e=d-1,f=a.charAt(e);" "!==f;)f=a.charAt(--e);c.push(a.substring(0,e)),a=a.substring(e).trim()}c.push(a)},paint:function(a){"use strict";var b=game._scale,c=game.stringHeight();a.fillStyle="rgb(0,0,0)",a.fillRect(this.x,this.y,this.w,this.h),a.strokeStyle="rgb(255,255,255)",a.lineWidth=2;var d=2*b;if(a.strokeRect(this.x+d,this.y+d,this.w-2*d,this.h-2*d),this.title){a.fillStyle="rgb(0,0,0)";var e=game.stringWidth(this.title);e+=4*b;var f=this.x+Math.floor((this.w-e)/2);a.fillRect(f,this.y,e,c),a.fillStyle="rgb(255,255,255)",game.drawString(this.title,f+2*b,this.y)}this.paintContent(a,this.y+this.getYMargin())},getXMargin:function(){"use strict";return 8*game._scale},getYMargin:function(){"use strict";return 8*game._scale},update:function(){},paintContent:function(){}},CommandBubble.prototype=Object.create(Bubble.prototype,{handleCommandChosen:{value:function(a){"use strict";switch(this.selection){case-1:a.startRoaming();break;case 0:a.talkToNpc();break;case 1:break;case 2:break;case 3:break;case 4:break;case 5:break;case 6:break;case 7:}}},handleInput:{value:function(){"use strict";var a=game.inputManager;
if(a.isKeyDown(gtp.Keys.UP_ARROW,!0))this.selection=this.selection-1,this.selection<0&&(this.selection=7);else if(a.isKeyDown(gtp.Keys.DOWN_ARROW,!0))this.selection=Math.floor((this.selection+1)%8);else if(this.selection>3&&a.isKeyDown(gtp.Keys.LEFT_ARROW,!0))this.selection-=4;else if(this.selection<4&&a.isKeyDown(gtp.Keys.RIGHT_ARROW,!0))this.selection+=4;else{if(a.isKeyDown(gtp.Keys.X,!0))return this.selection=-1,!0;if(a.isKeyDown(gtp.Keys.Z,!0))return game.audio.playSound("menu"),!0}return!1}},paintContent:{value:function(a,b){"use strict";var c=game._scale,d=this.x+20*c,e=b,f=game.stringHeight()+7*c;game.drawString("TALK",d,e),e+=f,game.drawString("STATUS",d,e),e+=f,game.drawString("STAIRS",d,e),e+=f,game.drawString("SEARCH",d,e),e+=f,d+=70*c,e-=4*f,game.drawString("SPELL",d,e),e+=f,game.drawString("ITEM",d,e),e+=f,game.drawString("DOOR",d,e),e+=f,game.drawString("TAKE",d,e),e+=f,this.selection<4&&(d-=70*c),d-=game.stringWidth(">")+2*c,e=b+f*(this.selection%4),game.drawArrow(d,e)}},reset:{value:function(){"use strict";this.selection=0}}}),CommandBubble.prototype.constructor=CommandBubble,TextBubble.HEIGHT=100,TextBubble.CHAR_RENDER_MILLIS=40,TextBubble.prototype=Object.create(Bubble.prototype,{handleInput:{value:function(){"use strict";if(this._textDone&&this._questionBubble){var a=this._questionBubble.handleInput();if(a){var b=this._questionBubble.getSelectedChoiceNextDialogue();return this._conversation.setDialogueState(b),delete this._questionBubble,!this._updateConversation()}return!1}if(!this._textDone&&game.anyKeyPressed())this._textDone=!0,this._curLine=this._lines.length-1;else if(game.anyKeyPressed())return!this._updateConversation();return!1}},update:{value:function(a){"use strict";this._textDone?this._questionBubble&&this._questionBubble.update(a):(this._curCharMillis+=a,this._curCharMillis>TextBubble.CHAR_RENDER_MILLIS&&(this._curCharMillis-=TextBubble.CHAR_RENDER_MILLIS,this._curOffs++,this._curOffs===this._lines[this._curLine].length&&(this._curLine===this._lines.length-1?this._textDone=!0:this._curLine++,this._curOffs=0)))}},paintContent:{value:function(a,b){"use strict";var c=this.x+Bubble.MARGIN;if(a.fillStyle="rgb(255,255,255)",this._lines){for(var d=0;d<=this._curLine;d++){var e=this._lines[d];this._textDone||d!==this._curLine||(e=e.substring(0,this._curOffs)),game.drawString(e,c,b),b+=10*game._scale}this._textDone&&this._conversation.hasNext()&&game.drawArrow(this.x+this.w-30,this.y+this.h-30)}this._textDone&&this._questionBubble&&this._questionBubble.paint(a)}},setText:{value:function(a){"use strict";if(this._text=a.text,this._text){var b=this.w-2*Bubble.MARGIN;this._lines=this._breakApart(this._text,b),this._curLine=this._curOffs=0,this._curCharMillis=0,this._textDone=!1}a.choices&&(this._questionBubble=new QuestionBubble(game,a.choices))}},setConversation:{value:function(a){"use strict";delete this._questionBubble,this._conversation=a,this.setText(this._conversation.start())}},_updateConversation:{value:function(){"use strict";return this._conversation.hasNext()?(this.setText(this._conversation.next()),!0):!1}}}),TextBubble.prototype.constructor=TextBubble,QuestionBubble.prototype=Object.create(Bubble.prototype,{handleInput:{value:function(){"use strict";if(game.cancelKeyPressed())this._curChoice=0;else if(game.actionKeyPressed())return this._done=!0,!0;return!1}},update:{value:function(){"use strict";var a=game.inputManager;a.isKeyDown(gtp.Keys.UP_ARROW,!0)?this._curChoice=Math.max(0,this._curChoice-1):a.isKeyDown(gtp.Keys.DOWN_ARROW,!0)&&(this._curChoice=Math.min(this._curChoice+1,this._choices.length-1))}},paintContent:{value:function(a,b){"use strict";var c=this.x+Bubble.MARGIN+10*game._scale;a.fillStyle="rgb(255,255,255)";for(var d=0;d<this._choices.length;d++)this._curChoice===d&&game.drawArrow(this.x+Bubble.MARGIN,b),game.drawString(this._choices[d].text,c,b),b+=10*game._scale}},getSelectedChoiceNextDialogue:{value:function(){"use strict";var a=this._choices[this._curChoice];return a.next?a.next.length?a.next:a.next():null}},setChoices:{value:function(a){"use strict";this._choices=a}}}),QuestionBubble.prototype.constructor=QuestionBubble,Direction=Object.freeze({NORTH:0,EAST:1,SOUTH:2,WEST:3}),Hero.STEP_INC=0,Hero.prototype=Object.create(RoamingEntity.prototype,{handleIntersectedObject:{value:function(a){"use strict";if("warp"===a.type){var b=parseInt(a.properties.row,10),c=parseInt(a.properties.col,10);game.loadMap(a.properties.map,b,c)}}},update:{value:function(a){"use strict";this._stepTick+=a,this._stepTick>=600?(this._stepTick-=600,Hero.STEP_INC=0):this._stepTick>=300&&(Hero.STEP_INC=1),this.handleIsMovingInUpdate()}},render:{value:function(a){"use strict";var b=game.getTileSize();this.spriteSheet||(this.spriteSheet=game.assets.get("hero"));var c=0,d=0;switch(this.direction){case Direction.NORTH:d=4;break;case Direction.SOUTH:break;case Direction.EAST:d=6;break;case Direction.WEST:d=2}d+=Hero.STEP_INC;var e=(game.canvas.width-b)/2,f=(game.canvas.height-b)/2;this.spriteSheet.drawSprite(a,e,f,c,d)}},handlePostMove:{value:function(){"use strict";var a=game.map.getLayer("warpLayer"),b=game.getTileSize(),c=this.mapCol*b,d=this.mapRow*b,e=a.getObjectIntersecting(c,d,b,b);e?this.handleIntersectedObject(e):0===game.randomInt(20)&&game.startRandomEncounter()}},addGold:{value:function(a){"use strict";this.gold=Math.max(0,this.gold+a)}}}),Hero.prototype.constructor=Hero;var LoadingState=function(){"use strict";this.assetsLoaded=!1};LoadingState.prototype=Object.create(_BaseState.prototype,{update:{value:function(){"use strict";if(this.handleDefaultKeys(),!this.assetsLoaded){this.assetsLoaded=!0;var a=this.game;setTimeout(function(){a.assets.addImage("title","res/title.png"),a.assets.addSpriteSheet("hero","res/hero.png",16,16,1,!0),a.assets.addSpriteSheet("npcs","res/npcs.png",16,16,1,!0),a.assets.addImage("font","res/font_10x10.png"),a.assets.addJson("overworld.json"),a.assets.addJson("brecconary.json"),a.assets.addSound("overworldMusic","res/sound/05 Dragon Quest 1 - Kingdom of Alefgard (22khz mono).ogg"),a.assets.addSound("bump","res/sound/42 Dragon Quest 1 - Bumping into Walls (22khz mono).wav"),a.assets.addSound("menu","res/sound/32 Dragon Quest 1 - Menu Button (22khz mono).wav"),a.assets.addSound("stairs","res/sound/30 Dragon Quest 1 - Stairs Down (22khz mono).wav"),a.assets.onLoad(function(){var b=a.assets.get("font");a.assets.set("font",new gtp.BitmapFont(b,20,20,12)),a.assets.addTmxMap(a.initLoadedMap("overworld.json")),a.assets.addTmxMap(a.initLoadedMap("brecconary.json")),a.assets.onLoad(function(){a.setState(new TitleScreenState)})})},1e3)}}},render:{value:function(a){"use strict";var b=this.game;b.clearScreen("rgb(0,0,255)"),a.fillStyle="rgb(0, 0, 0)",a.font="bold 30px Arial",a.fillText("Loading...",100,100)}}}),LoadingState.prototype.constructor=LoadingState;var MapChangeState=function(){"use strict";gtp.FadeOutInState.apply(this,arguments)};MapChangeState.prototype=Object.create(gtp.FadeOutInState.prototype,{init:{value:function(){"use strict";gtp.State.prototype.init.apply(this,arguments)}},_setState:{value:function(){"use strict";gtp.FadeOutInState.prototype._setState.apply(this,arguments),game.getMapLogic().init()}}}),MapLogic.prototype={init:function(){},npcText:function(){}},NpcType=Object.freeze({SOLDIER_GRAY:0,MAN_BLUE:1,WOMAN_BLUE:2,MERCHANT_GREEN:3,OLD_MAN_GRAY:4}),Npc.prototype=Object.create(RoamingEntity.prototype,{_computeColumn:{value:function(){"use strict";switch(this.direction){case Direction.NORTH:return 4;case Direction.EAST:return 2;default:case Direction.SOUTH:return 0;case Direction.WEST:return 6}}},update:{value:function(a){"use strict";this._stepDelay.update(a)?(this._step(),this._stepDelay.reset()):this.handleIsMovingInUpdate()}},render:{value:function(a){"use strict";var b=game.assets.get("npcs"),c=this.type,d=this._computeColumn(),e=this.mapCol*game.getTileSize();e-=game.getMapXOffs(),e+=this.xOffs;var f=this.mapRow*game.getTileSize();f-=game.getMapYOffs(),f+=this.yOffs,d+=Hero.STEP_INC,b.drawSprite(a,e,f,c,d)}},reset:{value:function(){"use strict";this.setMapLocation(this._origMapRow,this._origMapCol),this.direction=this._origDir,this._stepDelay.reset()}},setNpcIndex:{value:function(a){"use strict";this.npcIndex=a}},_step:{value:function(){"use strict";for(var a,b=[this.tryToMoveUp,this.tryToMoveDown,this.tryToMoveRight,this.tryToMoveLeft];!a;){var c=gtp.Utils.randomInt(0,4);b[c].call(this),a=!0}}}}),Npc.prototype.constructor=Npc;var TitleScreenState=function(){"use strict";this.assetsLoaded=!1};TitleScreenState.prototype=Object.create(_BaseState.prototype,{init:{value:function(a){"use strict";_BaseState.prototype.init.apply(this,arguments),a.canvas.addEventListener("touchstart",this.handleStart,!1),this._delay=new gtp.Delay([600,400]),this._blink=!0}},leaving:{value:function(a){"use strict";a.canvas.removeEventListener("touchstart",this.handleStart,!1)}},handleStart:{value:function(){"use strict";console.log("yee, touch detected!"),this._startGame()}},update:{value:function(a){"use strict";this.handleDefaultKeys(),this._delay.update(a)&&(this._delay.reset(),this._blink=!this._blink);var b=game.inputManager;b.isKeyDown(gtp.Keys.ENTER)&&this._startGame()}},render:{value:function(a){"use strict";var b=this.game;b.clearScreen();var c=b.getWidth(),d=b.assets.get("title"),e=(c-d.width)/2,f=30;if(d.draw(a,e,f),this._blink){var g="Press Enter";e=(c-b.stringWidth(g))/2,f=b.getHeight()-40,b.drawString(g,e,f)}}},_adjustGameMap:{value:function(){"use strict";for(var a=game.map,b=0;b<a.getLayerCount();b++){var c=a.getLayerByIndex(b);"tileLayer"!==c.name&&(c.visible=!1)}}},_startGame:{value:function(){"use strict";game.setMap("overworld.json"),game.hero.setMapLocation(52,45),game.setState(new gtp.FadeOutInState(this,new RoamingState))}}}),TitleScreenState.prototype.constructor=TitleScreenState;var _RoamingSubState=Object.freeze({ROAMING:0,MENU:1,TALKING:2}),RoamingState=function(){"use strict";this._substate=_RoamingSubState.ROAMING,this._updateMethods={},this._updateMethods[_RoamingSubState.ROAMING]=this._updateRoaming,this._updateMethods[_RoamingSubState.MENU]=this._updateMenu,this._updateMethods[_RoamingSubState.TALKING]=this._updateTalking,this._textBubble=new TextBubble(game),this._showTextBubble=!1,this._commandBubble=new CommandBubble};RoamingState.prototype=Object.create(_BaseState.prototype,{_totalTime:{value:0,writable:!0},update:{value:function(a){"use strict";this.handleDefaultKeys(),game.hero.update(a),RoamingState._totalTime+=a,RoamingState._totalTime>=1e3&&(RoamingState._totalTime=0),this._updateMethods[this._substate].call(this,a)}},_updateMenu:{value:function(){"use strict";var a=this._commandBubble.handleInput();return a?void this._commandBubble.handleCommandChosen(this):void 0}},_updateRoaming:{value:function(a){"use strict";var b=game.hero,c=game.inputManager;return game.actionKeyPressed()?(game.setNpcsPaused(!0),this._commandBubble.reset(),game.audio.playSound("menu"),void(this._substate=_RoamingSubState.MENU)):(b.isMoving()||(c.isKeyDown(gtp.Keys.UP_ARROW)?b.tryToMoveUp():c.isKeyDown(gtp.Keys.DOWN_ARROW)?b.tryToMoveDown():c.isKeyDown(gtp.Keys.LEFT_ARROW)?b.tryToMoveLeft():c.isKeyDown(gtp.Keys.RIGHT_ARROW)&&b.tryToMoveRight()),c.isKeyDown(gtp.Keys.SHIFT)&&(c.isKeyDown(gtp.Keys.C,!0)&&game.toggleShowCollisionLayer(),c.isKeyDown(gtp.Keys.T,!0)&&game.toggleShowTerritoryLayer(),c.isKeyDown(gtp.Keys.S,!0)&&game.audio.playSound("stairs")),void game.map.npcs.forEach(function(b){b.update(a)}))}},_updateTalking:{value:function(a){"use strict";var b=this._textBubble.handleInput();return this._showTextBubble&&this._textBubble.update(a),b?void this.startRoaming():void 0}},render:{value:function(a){"use strict";game.drawMap(a),game.hero.render(a),game.map.npcs.forEach(function(b){b.render(a)}),this._substate===_RoamingSubState.MENU&&this._commandBubble.paint(a),this._showTextBubble&&this._textBubble.paint(a)}},startRoaming:{value:function(){"use strict";game.setNpcsPaused(!1),this._showTextBubble=!1,this._substate=_RoamingSubState.ROAMING}},talkToNpc:{value:function(){"use strict";var a=game.getMapLogic();if(!a)return void console.log("Error: No map logic found for this map!  Cannot talk to NPCs!");var b=new Conversation,c=game.getNpcHeroIsFacing();if(c){var d=game.hero,e=(d.direction+2)%4;c.direction=e,b.setSegments(a.npcText(c))}else b.addSegment("There is nobody in that direction!");this._showTextBubble=!0,this._textBubble.setConversation(b),this._substate=_RoamingSubState.TALKING}}}),RoamingState.prototype.constructor=RoamingState,Conversation.prototype=function(){"use strict";return{addSegment:function(a){a.length&&(a={text:a}),this._segments.push(a)},setSegments:function(a){if(Array.isArray(a))for(var b=0;b<a.length;b++)this.addSegment(a[b]);else this.addSegment(a)},start:function(){return this._segmentIndex=0,this.next()},hasNext:function(){return this._segmentIndex<this._segments.length},next:function(){return this._segments[this._segmentIndex++]},setDialogueState:function(a){a||(this._segmentIndex=this._segments.length);for(var b=0;b<this._segments.length;b++)if(this._segments[b].id===a)return void(this._segmentIndex=b);console.error('Unknown next dialogue state: "'+a+'"'),this._segmentIndex=this._segments.length}}}(),Brecconary.prototype=function(){"use strict";var a={greeter:function(){return"Welcome to Brecconary!"},oldman1:function(a){return a.hero.strength<100?["Brave traveler, you must save us from the dreaded Dragon Lord!!","But you should buy some supplies before venturing out...",{id:"makeUserChoose",text:"Do you want my help?",choices:[{text:"Yes",next:function(){return a.hero.addGold(10),"iGaveYouMoney"}},{text:"Nope",next:"makeUserChoose"}]},{id:"iGaveYouMoney",text:"I've given you all I have... 100 gold.  Good luck, my child."}]:"Wow, you are strong! I cannot help you.  Go, defeat the Dragon Lord!"},innkeeper:function(){return"Sorry, the inn is temporarily closed while we renovate."},merchant1:function(){return"I'm all sold out after the Carnival yesterday.  Boy, you missed out on some good deals!"}};return Object.create(MapLogic.prototype,{init:{value:function(){}},npcText:{value:function(b){console.log("Talking to: "+JSON.stringify(b));var c=a[b.name];return c?c(game):"I have nothing to say..."}}})}(),Brecconary.prototype.constructor=Brecconary,Overworld.prototype=function(){"use strict";var a={};return Object.create(MapLogic.prototype,{init:{value:function(){}},npcText:{value:function(b){return console.log("Talking to: "+JSON.stringify(b)),a[b.name]||"I have nothing to say..."}}})}(),Overworld.prototype.constructor=Overworld;